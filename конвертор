import json
import logging
import os
import io
import telebot
from telebot import types
from gtts import gTTS, lang as gtts_lang # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤ gTTS
import PyPDF2
import docx
import tempfile # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ø–Ω–¥–µ–∫—Å–∞
API_TOKEN = os.environ.get('BOT_TOKEN')
bot = telebot.TeleBot(API_TOKEN)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è!)
user_language = {}

### --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î –ò –§–£–ù–ö–¶–ò–ò --- ###

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å
def convert_text_to_audio(text, lang='ru'):
    # gTTS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫, –µ—Å–ª–∏ lang –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ
    try:
        tts = gTTS(text=text, lang=lang, slow=False)
    except ValueError:
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —è–∑—ã–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –ø—É—Å—Ç, –ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é gTTS)
        tts = gTTS(text=text, slow=False)
        logging.info(f"Using auto-detected language for chat_id: {user_language.get(tts.lang)}")
        
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å–∞ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç–æ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ
    with tempfile.NamedTemporaryFile(suffix=".mp3", delete=False) as temp_audio_file:
        tts.save(temp_audio_file.name)
        return temp_audio_file.name

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def handle_start(message):
    chat_id = message.chat.id
    bot.send_message(chat_id, "–ü—Ä–∏–≤–µ—Ç! –Ø –ê—É–¥–∏–æ–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ë–æ—Ç. –Ø –ø—Ä–µ–≤—Ä–∞—â—É —Ç–≤–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã (PDF, DOCX, TXT) –≤ MP3 –∞—É–¥–∏–æ–∫–Ω–∏–≥—É. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª –∏–ª–∏ —Ç–µ–∫—Å—Ç!")
    
    markup = types.InlineKeyboardMarkup()
    # –ö–ù–û–ü–ö–ò –î–õ–Ø –†–£–°–°–ö–û–ì–û, –ê–ù–ì–õ–ò–ô–°–ö–û–ì–û, –ù–ï–ú–ï–¶–ö–û–ì–û, –§–†–ê–ù–¶–£–ó–°–ö–û–ì–û
    itembtnru = types.InlineKeyboardButton('RU üá∑üá∫', callback_data='language_ru')
    itembtnen = types.InlineKeyboardButton('EN üá¨üáß', callback_data='language_en')
    itembtnde = types.InlineKeyboardButton('DE üá©üá™', callback_data='language_de')
    itembtnfr = types.InlineKeyboardButton('FR üá´üá∑', callback_data='language_fr')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Ä–∞–∑–º–µ—Ç–∫—É
    markup.add(itembtnru, itembtnen, itembtnde, itembtnfr)
    bot.send_message(chat_id, "üëá –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç, —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ (Callback handler)
@bot.callback_query_handler(func=lambda call: call.data.startswith('language_'))
def callback_inline_language(call):
    lang_code = call.data.split('_')[1]
    user_language[call.message.chat.id] = lang_code
    bot.edit_message_text(chat_id=call.message.chat.id, 
                          message_id=call.message.message_id, 
                          text=f"–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {lang_code.upper()}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞)
@bot.message_handler(content_types=['text'])
def handle_text(message):
    chat_id = message.chat.id
    text = message.text
    # –ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω –∫–Ω–æ–ø–∫–æ–π, gTTS –ø–æ–ø—Ä–æ–±—É–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    lang = user_language.get(chat_id) 
    
    try:
        audio_path = convert_text_to_audio(text, lang)
        with open(audio_path, 'rb') as audio_file:
            bot.send_audio(chat_id, audio_file)
        os.remove(audio_path) # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞: {e}")
        bot.send_message(chat_id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –∞—É–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ (PDF, DOCX, TXT)
@bot.message_handler(content_types=['document'])
def handle_document(message):
    chat_id = message.chat.id
    file_info = bot.get_file(message.document.file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
    lang = user_language.get(chat_id)

    try:
        text = ""
        if message.document.file_name.endswith('.pdf'):
            reader = PyPDF2.PdfReader(io.BytesIO(downloaded_file))
            for page in reader.pages:
                text += page.extract_text() or ""
        elif message.document.file_name.endswith('.docx'):
            doc = docx.Document(io.BytesIO(downloaded_file))
            for para in doc.paragraphs:
                text += para.text + "\n"
        elif message.document.file_name.endswith('.txt'):
            text = downloaded_file.decode('utf-8')
        else:
            bot.send_message(chat_id, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é —Ç–æ–ª—å–∫–æ PDF, DOCX –∏ TXT —Ñ–∞–π–ª—ã.")
            return

        if not text.strip():
            bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç.")
            return

        audio_path = convert_text_to_audio(text[:3000], lang) # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è gTTS
        with open(audio_path, 'rb') as audio_file:
            bot.send_audio(chat_id, audio_file, caption="–í–∞—à–µ –∞—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ!")
        os.remove(audio_path)
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")
        bot.send_message(chat_id, f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

### --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –Ø–ù–î–ï–ö–°.–û–ë–õ–ê–ö–ê (–¢–û–ß–ö–ê –í–•–û–î–ê) --- ###

def handler(event, context):
    if 'body' not in event:
        return {'statusCode': 400, 'body': 'Bad Request'}

    try:
        update = telebot.types.Update.de_json(event['body'])
        bot.process_new_updates([update])
        return {'statusCode': 200, 'body': 'ok'}
    except Exception as e:
        logging.error(f"Error processing update: {e}")
        return {'statusCode': 500, 'body': 'Internal Server Error'}
